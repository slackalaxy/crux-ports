# Description: Viber for PC
# URL: https://viber.com
# Maintainer: Petar Petrov, slackalaxy at gmail dot com
# Depends on: chromaprint cups double-conversion graphite2 gst-plugins-bad gtk3 krb5 libevent libidn2 libinput libmng librsvg libssh libtiff44 libxslt minizip openssl11 pulseaudio qt6-multimedia qt6-pdfwidgets qt6-wayland snappy speex tslib x264 x265 xorg-libxcursor xorg-libxinerama xorg-libxkbfile xorg-libxscrnsaver

name=viber
version=current
#version=$(ar p $name.deb control.tar.gz | tar zxO ./control | grep Version | awk '{print $2}' | cut -d- -f1)
release=13
source=(http://download.cdn.viber.com/cdn/desktop/Linux/viber.deb
	https://github.com/ChiefMikeK/ttf-symbola/archive/0fdcdd1/ttf-symbola-0fdcdd10ca2c15e03b1d06cc1a80d68fbab258f4.tar.gz
	$name.fonts.conf)

build() {
	cd $PKG
	ar p $SRC/$name.deb data.tar.xz | xz -d | tar xv
	mkdir -p $PKG/usr/lib/$name
	mv $PKG/opt/$name/* $PKG/usr/lib/$name
	rm -rf $PKG/opt
	rm -rf $PKG/usr/share/viber
	
	# Fix desktop launcher
	# see about custom fonts config: https://bbs.archlinux.org/viewtopic.php?pid=1924209#p1924209
	sed -i 's:/opt/viber/Viber:env FONTCONFIG_FILE=/etc/fonts/viber.conf /usr/bin/ViberPC:' $PKG/usr/share/applications/$name.desktop
	sed -i 's:/usr/share/pixmaps/viber.png:viber:' $PKG/usr/share/applications/$name.desktop
	
	mkdir -p $PKG/usr/bin
	printf "#!/bin/sh\n/usr/lib/$name/Viber\n" > $PKG/usr/bin/ViberPC
	ln -s ViberPC $PKG/usr/bin/$name
	chmod +x $PKG/usr/bin/ViberPC
	
	chmod 755 $PKG/usr
	chmod 755 $PKG/usr/share
	
	mkdir -p $PKG/etc/fonts
	cp -a $SRC/$name.fonts.conf $PKG/etc/fonts/$name.conf
	install -D -m 0644 $SRC/ttf-symbola-0fdcdd10ca2c15e03b1d06cc1a80d68fbab258f4/Symbola-13.otf $PKG/usr/lib/viber/fonts/Symbola.otf

	find $PKG/usr/lib/viber/translations/ -maxdepth 1 -type f -not -name "*_en.qm" -delete
	
	cd $PKG/usr/lib/$name/lib
	ln -s /usr/lib/libavformat.so libavformat.so.58
	ln -s /usr/lib/libavcodec.so libavcodec.so.58
	ln -s /usr/lib/libswresample.so libswresample.so.3
	ln -s /usr/lib/libswscale.so libswscale.so.5
	ln -s /usr/lib/libavutil.so libavutil.so.56
}
